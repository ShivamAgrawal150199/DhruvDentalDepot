const inventory = [
  {
    title: "Instrument 01",
    category: "Accessories",
    image: "images/ChatGPT Image Feb 7, 2026, 06_06_40 PM.png",
    note: ""
  },
  {
    title: "Instrument 02",
    category: "Accessories",
    image: "images/ChatGPT Image Feb 7, 2026, 11_27_32 PM.png",
    note: ""
  },
  {
    title: "Instrument 03",
    category: "Accessories",
    image: "images/ChatGPT Image Feb 7, 2026, 11_38_07 PM.png",
    note: ""
  },
  {
    title: "Instrument 04",
    category: "Accessories",
    image: "images/ChatGPT Image Feb 8, 2026, 12_27_42 AM.png",
    note: ""
  },
  {
    title: "Instrument 05",
    category: "Accessories",
    image: "images/ChatGPT Image Feb 8, 2026, 12_37_07 AM.png",
    note: "",
    fit: "contain"
  },
  {
    title: "Instrument 06",
    category: "Accessories",
    image: "images/ChatGPT Image Feb 8, 2026, 12_41_05 AM.png",
    note: "",
    fit: "contain"
  },
  {
    title: "Instrument 07",
    category: "Accessories",
    image: "images/ChatGPT Image Feb 8, 2026, 12_43_30 AM.png",
    note: "",
    fit: "contain"
  },
  {
    title: "Portable Turbine Unit",
    category: "Accessories",
    image: "images/portableTrurbineUnitchnfged1.jpeg",
    note: ""
  },
  {
    title: "Instrument 08",
    category: "Accessories",
    image: "images/WhatsApp Image 2026-02-07 at 18.09.13.jpeg",
    note: ""
  },
  {
    title: "New 01",
    category: "Accessories",
    image: "images/new1.jpeg",
    note: ""
  },
  {
    title: "New 02",
    category: "Accessories",
    image: "images/new2.jpeg",
    note: ""
  },
  {
    title: "New 03",
    category: "Accessories",
    image: "images/new3.jpeg",
    note: ""
  },
  {
    title: "New 04",
    category: "Accessories",
    image: "images/new4.png",
    note: ""
  },
  {
    title: "New 05",
    category: "Accessories",
    image: "images/new5.png",
    note: ""
  },
  {
    title: "New 06",
    category: "Accessories",
    image: "images/new6.jpeg",
    note: ""
  },
  {
    title: "New 07",
    category: "Accessories",
    image: "images/new7.png",
    note: ""
  },
  {
    title: "Compressor 01",
    category: "Dental Compressor Parts",
    image: "images/Comp1.jpeg",
    note: ""
  },
  {
    title: "Compressor 02",
    category: "Dental Compressor Parts",
    image: "images/Comp2.jpg",
    note: ""
  },
  {
    title: "Compressor 03",
    category: "Dental Compressor Parts",
    image: "images/Comp3.png",
    note: ""
  },
  {
    title: "Compressor 04",
    category: "Dental Compressor Parts",
    image: "images/Comp4.jpg",
    note: ""
  },
  {
    title: "Compressor 05",
    category: "Dental Compressor Parts",
    image: "images/Comp5.jpg",
    note: ""
  },
  {
    title: "Compressor 06",
    category: "Dental Compressor Parts",
    image: "images/Comp6.jpg",
    note: ""
  },
  {
    title: "Compressor 07",
    category: "Dental Compressor Parts",
    image: "images/Comp7.jpg",
    note: ""
  },
  {
    title: "Compressor 08",
    category: "Dental Compressor Parts",
    image: "images/Comp8.jpg",
    note: ""
  },
  {
    title: "Compressor 09",
    category: "Dental Compressor Parts",
    image: "images/Comp9.jpeg",
    note: ""
  },
  {
    title: "Compressor 10",
    category: "Dental Compressor Parts",
    image: "images/Comp10.jpeg",
    note: ""
  },
  {
    title: "Compressor 11",
    category: "Dental Compressor Parts",
    image: "images/Comp11.png",
    note: ""
  },
  {
    title: "Compressor 12",
    category: "Dental Compressor Parts",
    image: "images/Comp12.png",
    note: ""
  },
  {
    title: "Compressor 13",
    category: "Dental Compressor Parts",
    image: "images/Comp13.jpeg",
    note: ""
  },
  {
    title: "Compressor 14",
    category: "Dental Compressor Parts",
    image: "images/Comp14.jpeg",
    note: ""
  },
  {
    title: "Air Scalar",
    category: "Dental Handpieces",
    image: "images/airScalar.jpeg",
    note: ""
  },
  {
    title: "Handpiece 2",
    category: "Dental Handpieces",
    image: "images/handpiece2.jpg",
    note: ""
  },
  {
    title: "3 Way Syringe",
    category: "Dental Handpieces",
    image: "images/3waysyringe.jpeg",
    note: "",
    fit: "contain"
  },
  {
    title: "Chair Part 01",
    category: "Dental Chair Parts",
    image: "images/chairparts1.png",
    note: ""
  },
  {
    title: "Chair Part 02",
    category: "Dental Chair Parts",
    image: "images/chairparts2.png",
    note: ""
  },
  {
    title: "Chair Part 03",
    category: "Dental Chair Parts",
    image: "images/chairparts3.png",
    note: ""
  },
  {
    title: "Chair Part 04",
    category: "Dental Chair Parts",
    image: "images/chairparts4.png",
    note: ""
  },
  {
    title: "Chair Part 05",
    category: "Dental Chair Parts",
    image: "images/chairparts5.png",
    note: ""
  },
  {
    title: "Chair Part 06",
    category: "Dental Chair Parts",
    image: "images/chairparts6.png",
    note: ""
  },
  {
    title: "Chair Part 07",
    category: "Dental Chair Parts",
    image: "images/chairparts7.png",
    note: ""
  },
  {
    title: "Chair Part 08",
    category: "Dental Chair Parts",
    image: "images/chairparts8.png",
    note: ""
  },
  {
    title: "Chair Part 09",
    category: "Dental Chair Parts",
    image: "images/chairparts9.png",
    note: ""
  },
  {
    title: "Chair Part 10",
    category: "Dental Chair Parts",
    image: "images/chairparts10.png",
    note: ""
  },
  {
    title: "Chair Part 11",
    category: "Dental Chair Parts",
    image: "images/chairparts11.png",
    note: ""
  },
  {
    title: "Chair Part 12",
    category: "Dental Chair Parts",
    image: "images/chairparts12.png",
    note: ""
  },
  {
    title: "Chair Part 13",
    category: "Dental Chair Parts",
    image: "images/chairparts13.png",
    note: ""
  },
  {
    title: "Scaler Part 01",
    category: "Dental Scaler Parts",
    image: "images/scalerparts1.jpeg",
    note: ""
  },
  {
    title: "Scaler Part 02",
    category: "Dental Scaler Parts",
    image: "images/scalarparts2.jpeg",
    note: ""
  },
  {
    title: "Scaler Part 03",
    category: "Dental Scaler Parts",
    image: "images/scalerparts3.png",
    note: ""
  },
  {
    title: "Scaler Part 04",
    category: "Dental Scaler Parts",
    image: "images/scalarparts4.jpeg",
    note: ""
  }
].map((item, index) => ({
  id: `prd-${index + 1}`,
  ...item
}));

const CART_KEY = "ddd_cart";
const SESSION_KEY = "ddd_session_profile";
const API_BASE = "http://localhost:4000";

const productMap = new Map(inventory.map((item) => [item.id, item]));

const grid = document.getElementById("grid");
const filters = document.getElementById("filters");
const pageCategory = document.body?.dataset?.category || "All";

const categories = ["All", ...new Set(inventory.map((item) => item.category))];

function safeJsonParse(value, fallback) {
  try {
    return JSON.parse(value) || fallback;
  } catch {
    return fallback;
  }
}

async function apiRequest(path, options = {}) {
  const response = await fetch(`${API_BASE}${path}`, {
    method: options.method || "GET",
    credentials: "include",
    headers: {
      "Content-Type": "application/json",
      ...(options.headers || {})
    },
    body: options.body ? JSON.stringify(options.body) : undefined
  });

  let payload = {};
  try {
    payload = await response.json();
  } catch {
    payload = {};
  }

  if (!response.ok) {
    const error = new Error(payload.error || "Request failed");
    error.status = response.status;
    throw error;
  }

  return payload;
}

function getSession() {
  return safeJsonParse(localStorage.getItem(SESSION_KEY), null);
}

function saveSession(session) {
  localStorage.setItem(SESSION_KEY, JSON.stringify(session));
}

function clearSession() {
  localStorage.removeItem(SESSION_KEY);
}

async function refreshSessionFromServer() {
  try {
    const data = await apiRequest("/auth/me");
    if (data?.user) {
      saveSession(data.user);
      return data.user;
    }
    clearSession();
    return null;
  } catch (error) {
    if (error.status === 401) {
      clearSession();
      return null;
    }
    return getSession();
  }
}

function getCart() {
  return safeJsonParse(localStorage.getItem(CART_KEY), []);
}

function saveCart(cart) {
  localStorage.setItem(CART_KEY, JSON.stringify(cart));
  updateCartBadge();
}

function getCartCount() {
  return getCart().reduce((sum, item) => sum + item.qty, 0);
}

function updateCartBadge() {
  const count = getCartCount();
  document.querySelectorAll("[data-cart-count]").forEach((badge) => {
    badge.textContent = String(count);
    badge.classList.toggle("visible", count > 0);
  });
}

function renderAuthNav() {
  const navLinks = document.querySelector(".nav-links");
  if (!navLinks) return;

  const session = getSession();
  let authLink = navLinks.querySelector("[data-auth-link]");
  let logoutBtn = navLinks.querySelector("[data-logout-btn]");

  if (!authLink) {
    authLink = document.createElement("a");
    authLink.setAttribute("data-auth-link", "true");
    navLinks.appendChild(authLink);
  }

  if (session) {
    authLink.href = "login.html?next=checkout.html";
    authLink.textContent = session.name ? `Hi, ${session.name}` : "My Account";

    if (!logoutBtn) {
      logoutBtn = document.createElement("button");
      logoutBtn.type = "button";
      logoutBtn.className = "nav-btn";
      logoutBtn.setAttribute("data-logout-btn", "true");
      logoutBtn.textContent = "Logout";
      navLinks.appendChild(logoutBtn);
    }
  } else {
    authLink.href = "login.html?next=checkout.html";
    authLink.textContent = "Login";
    if (logoutBtn) logoutBtn.remove();
  }
}

function setupMobileNavMenu() {
  const topNav = document.querySelector(".top-nav");
  const navLinks = topNav?.querySelector(".nav-links");
  if (!topNav || !navLinks) return;

  let toggle = topNav.querySelector(".nav-toggle");
  if (!toggle) {
    toggle = document.createElement("button");
    toggle.type = "button";
    toggle.className = "nav-toggle";
    toggle.textContent = "Menu";
    toggle.setAttribute("aria-expanded", "false");
    topNav.insertBefore(toggle, navLinks);
  }

  toggle.addEventListener("click", () => {
    const open = topNav.classList.toggle("menu-open");
    toggle.setAttribute("aria-expanded", String(open));
  });

  navLinks.addEventListener("click", (event) => {
    const target = event.target;
    if (!(target instanceof HTMLElement)) return;
    if (!target.closest("a")) return;
    if (!topNav.classList.contains("menu-open")) return;
    topNav.classList.remove("menu-open");
    toggle.setAttribute("aria-expanded", "false");
  });
}

function addToCart(productId) {
  const cart = getCart();
  const existing = cart.find((item) => item.id === productId);
  if (existing) {
    existing.qty += 1;
  } else {
    cart.push({ id: productId, qty: 1 });
  }
  saveCart(cart);
}

function changeQty(productId, delta) {
  const cart = getCart();
  const index = cart.findIndex((item) => item.id === productId);
  if (index === -1) return;
  cart[index].qty += delta;
  if (cart[index].qty <= 0) {
    cart.splice(index, 1);
  }
  saveCart(cart);
  renderCartPage();
  renderCheckoutSummary();
}

function removeItem(productId) {
  const nextCart = getCart().filter((item) => item.id !== productId);
  saveCart(nextCart);
  renderCartPage();
  renderCheckoutSummary();
}

function getCartDetailed() {
  return getCart()
    .map((line) => {
      const product = productMap.get(line.id);
      if (!product) return null;
      return {
        ...line,
        product
      };
    })
    .filter(Boolean);
}

function renderFilters() {
  if (!filters) return;
  filters.innerHTML = "";
  categories.forEach((cat) => {
    const btn = document.createElement("button");
    btn.className = "filter-btn" + (cat === "All" ? " active" : "");
    btn.textContent = cat;
    btn.addEventListener("click", () => {
      document.querySelectorAll(".filter-btn").forEach((b) => b.classList.remove("active"));
      btn.classList.add("active");
      renderCards(cat);
    });
    filters.appendChild(btn);
  });
}

function renderCards(category) {
  if (!grid) return;
  const data = category === "All" ? inventory : inventory.filter((item) => item.category === category);
  grid.innerHTML = "";

  if (data.length === 0) {
    const empty = document.createElement("div");
    empty.className = "empty";
    empty.textContent = "No products yet. Add items in script.js.";
    grid.appendChild(empty);
    return;
  }

  data.forEach((item, index) => {
    const card = document.createElement("article");
    card.className = "card fade-in";
    card.style.animationDelay = `${index * 0.04}s`;

    const fitClass = item.fit === "contain" ? "fit-contain" : "";
    card.innerHTML = `
      <div class="card-media">
        <img src="${item.image}" alt="${item.title}" class="${fitClass}" />
      </div>
      <div class="card-body">
        <span class="tag">${item.category}</span>
        <h4>${item.title}</h4>
        <p>${item.note || "Available on request"}</p>
        <div class="card-actions">
          <button class="primary add-cart-btn" data-id="${item.id}" type="button">Add to Cart</button>
        </div>
      </div>
    `;

    grid.appendChild(card);
  });
}

function renderCartPage() {
  const cartItemsRoot = document.getElementById("cartItems");
  const cartTotalCount = document.getElementById("cartTotalCount");
  const checkoutBtn = document.getElementById("goCheckout");

  if (!cartItemsRoot) return;

  const detailed = getCartDetailed();
  cartItemsRoot.innerHTML = "";

  if (detailed.length === 0) {
    cartItemsRoot.innerHTML = `<div class="empty">Your cart is empty.</div>`;
    if (cartTotalCount) cartTotalCount.textContent = "0";
    if (checkoutBtn) {
      checkoutBtn.setAttribute("aria-disabled", "true");
      checkoutBtn.href = "#";
    }
    return;
  }

  detailed.forEach((line) => {
    const row = document.createElement("article");
    row.className = "cart-item";
    row.innerHTML = `
      <img src="${line.product.image}" alt="${line.product.title}" />
      <div>
        <h4>${line.product.title}</h4>
        <p>${line.product.category}</p>
      </div>
      <div class="qty-group">
        <button type="button" data-action="minus" data-id="${line.id}">-</button>
        <span>${line.qty}</span>
        <button type="button" data-action="plus" data-id="${line.id}">+</button>
      </div>
      <button class="ghost small" type="button" data-action="remove" data-id="${line.id}">Remove</button>
    `;
    cartItemsRoot.appendChild(row);
  });

  const totalCount = detailed.reduce((sum, line) => sum + line.qty, 0);
  if (cartTotalCount) cartTotalCount.textContent = String(totalCount);
  if (checkoutBtn) {
    const loggedIn = Boolean(getSession());
    checkoutBtn.href = loggedIn ? "checkout.html" : "login.html?next=checkout.html";
    checkoutBtn.textContent = loggedIn ? "Proceed to Checkout" : "Login to Checkout";
    checkoutBtn.removeAttribute("aria-disabled");
  }
}

function renderCheckoutSummary() {
  const summaryRoot = document.getElementById("orderSummary");
  if (!summaryRoot) return;

  const detailed = getCartDetailed();
  if (detailed.length === 0) {
    summaryRoot.innerHTML = `<div class="empty">Your cart is empty. Add products before checkout.</div>`;
    return;
  }

  summaryRoot.innerHTML = detailed
    .map((line) => `<li>${line.product.title} <strong>x ${line.qty}</strong></li>`)
    .join("");
}

async function requireAuthForCheckout() {
  const needsAuth = document.body?.dataset?.requiresAuth === "true";
  if (!needsAuth) return true;
  if (getSession()) return true;
  const user = await refreshSessionFromServer();
  if (user) return true;
  window.location.href = "login.html?next=checkout.html";
  return false;
}

function handleCheckoutSubmit() {
  const form = document.getElementById("checkoutForm");
  const status = document.getElementById("checkoutStatus");
  if (!form) return;

  form.addEventListener("submit", async (event) => {
    event.preventDefault();

    const detailed = getCartDetailed();
    if (detailed.length === 0) {
      if (status) status.textContent = "Your cart is empty. Add products before placing order.";
      return;
    }

    const currentUser = (await refreshSessionFromServer()) || getSession();
    if (!currentUser) {
      window.location.href = "login.html?next=checkout.html";
      return;
    }

    const formData = new FormData(form);
    const payload = {
      customer: {
        name: formData.get("name"),
        phone: formData.get("phone"),
        email: formData.get("email"),
        address: formData.get("address"),
        city: formData.get("city"),
        state: formData.get("state"),
        pinCode: formData.get("pinCode"),
        note: formData.get("note")
      },
      items: detailed.map((line) => ({
        id: line.id,
        title: line.product.title,
        category: line.product.category,
        qty: line.qty
      }))
    };

    try {
      const data = await apiRequest("/orders", {
        method: "POST",
        body: payload
      });

      const orderId = data?.order?.id || "N/A";
      saveCart([]);
      form.reset();
      renderCheckoutSummary();

      if (status) {
        status.textContent = `Order placed successfully. Your order ID is ${orderId}.`;
      }
    } catch (error) {
      if (status) {
        status.textContent = error.message || "Could not place order. Please try again.";
      }
    }
  });
}

async function setupAuthPage() {
  const form = document.getElementById("authForm");
  const status = document.getElementById("authStatus");
  if (!form) return;

  const params = new URLSearchParams(window.location.search);
  const next = params.get("next") || "checkout.html";

  const existing = (await refreshSessionFromServer()) || getSession();
  if (existing) {
    window.location.href = next;
    return;
  }

  form.addEventListener("submit", async (event) => {
    event.preventDefault();
    const formData = new FormData(form);
    const submitter = event.submitter;
    const action =
      (submitter instanceof HTMLButtonElement && submitter.value) ||
      String(formData.get("action") || "login");
    const name = String(formData.get("name") || "").trim();
    const email = String(formData.get("email") || "").trim().toLowerCase();
    const password = String(formData.get("password") || "");

    if (!email || !password) {
      if (status) status.textContent = "Email and password are required.";
      return;
    }

    try {
      let data;
      if (action === "register") {
        if (!name) {
          if (status) status.textContent = "Name is required for registration.";
          return;
        }
        data = await apiRequest("/auth/register", {
          method: "POST",
          body: { name, email, password }
        });
      } else {
        data = await apiRequest("/auth/login", {
          method: "POST",
          body: { email, password }
        });
      }

      if (data?.user) {
        saveSession(data.user);
      }
      window.location.href = next;
    } catch (error) {
      if (status) status.textContent = error.message || "Authentication failed.";
    }
  });
}

function setupCartInteractions() {
  if (grid) {
    grid.addEventListener("click", (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;
      const btn = target.closest(".add-cart-btn");
      if (!btn) return;

      const productId = btn.getAttribute("data-id");
      if (!productId) return;

      addToCart(productId);
      const original = btn.textContent;
      btn.textContent = "Added";
      setTimeout(() => {
        btn.textContent = original || "Add to Cart";
      }, 700);
    });
  }

  const cartItemsRoot = document.getElementById("cartItems");
  if (cartItemsRoot) {
    cartItemsRoot.addEventListener("click", (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;
      const button = target.closest("button[data-action]");
      if (!button) return;

      const action = button.getAttribute("data-action");
      const id = button.getAttribute("data-id");
      if (!action || !id) return;

      if (action === "plus") changeQty(id, 1);
      if (action === "minus") changeQty(id, -1);
      if (action === "remove") removeItem(id);
    });
  }

  document.addEventListener("click", async (event) => {
    const target = event.target;
    if (!(target instanceof HTMLElement)) return;
    if (!target.closest("[data-logout-btn]")) return;
    try {
      await apiRequest("/auth/logout", { method: "POST" });
    } catch {
      // Ignore and clear local session anyway.
    }
    clearSession();
    renderAuthNav();
    renderCartPage();
    if (document.body?.dataset?.requiresAuth === "true") {
      window.location.href = "login.html?next=checkout.html";
    }
  });
}

async function bootstrap() {
  if (pageCategory !== "All" && filters) {
    filters.style.display = "none";
  }

  const canLoad = await requireAuthForCheckout();
  if (!canLoad) return;

  renderFilters();
  renderCards(pageCategory);
  renderCartPage();
  renderCheckoutSummary();
  setupCartInteractions();
  handleCheckoutSubmit();
  await setupAuthPage();
  updateCartBadge();
  renderAuthNav();
  setupMobileNavMenu();

  const user = await refreshSessionFromServer();
  if (user) {
    renderAuthNav();
    renderCartPage();
  }
}

bootstrap();
